openapi: 3.1.0
info:
  description: "Video streaming service with S3/MinIO, signed URLs, and watch progress\
    \ tracking"
  title: Streaming Service
  version: 1.0.0
servers:
- url: /
paths:
  /api/v1/stream/{movie_id}:
    post:
      description: |-
        Start streaming a movie

        **Access Control:**
        - Requires valid JWT token
        - Requires active subscription

        **Returns:**
        - Signed URL for HLS/DASH manifest
        - URL expires in 1 hour

        **Example:**
        ```bash
        curl -X POST http://localhost:8005/api/v1/stream/{movie_id} \
          -H "Authorization: Bearer <token>" \
          -H "Content-Type: application/json" \
          -d '{"manifest_type": "hls"}'
        ```
      operationId: start_streaming_api_v1_stream__movie_id__post
      parameters:
      - explode: false
        in: path
        name: movie_id
        required: true
        schema:
          title: Movie Id
          type: string
        style: simple
      - explode: false
        in: header
        name: authorization
        required: true
        schema:
          title: Authorization
          type: string
        style: simple
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StreamRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StreamResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Start Streaming
      tags:
      - Streaming
  /api/v1/stream/{movie_id}/progress:
    get:
      description: |-
        Get current watch progress

        **Returns:**
        - Current playback position
        - Last watched timestamp

        **Example:**
        ```bash
        curl http://localhost:8005/api/v1/stream/{movie_id}/progress \
          -H "Authorization: Bearer <token>"
        ```
      operationId: get_watch_progress_api_v1_stream__movie_id__progress_get
      parameters:
      - explode: false
        in: path
        name: movie_id
        required: true
        schema:
          title: Movie Id
          type: string
        style: simple
      - explode: false
        in: header
        name: authorization
        required: true
        schema:
          title: Authorization
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WatchProgressResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Get Watch Progress
      tags:
      - Streaming
    post:
      description: |-
        Update watch progress

        **Tracking:**
        - Saved to Redis (fast access)
        - Synced to PostgreSQL (persistent storage)
        - Kafka event published

        **Client should call this endpoint periodically (e.g., every 10 seconds)**

        **Example:**
        ```bash
        curl -X POST http://localhost:8005/api/v1/stream/{movie_id}/progress \
          -H "Authorization: Bearer <token>" \
          -H "Content-Type: application/json" \
          -d '{"position_seconds": 120}'
        ```
      operationId: update_watch_progress_api_v1_stream__movie_id__progress_post
      parameters:
      - explode: false
        in: path
        name: movie_id
        required: true
        schema:
          title: Movie Id
          type: string
        style: simple
      - explode: false
        in: header
        name: authorization
        required: true
        schema:
          title: Authorization
          type: string
        style: simple
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProgressUpdateRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProgressUpdateResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Update Watch Progress
      tags:
      - Streaming
  /api/v1/stream/{movie_id}/stop:
    post:
      description: |-
        Stop streaming session

        **Actions:**
        - Updates final watch progress
        - Publishes stream.stop event
        - Ends stream session

        **Example:**
        ```bash
        curl -X POST http://localhost:8005/api/v1/stream/{movie_id}/stop \
          -H "Authorization: Bearer <token>" \
          -H "Content-Type: application/json" \
          -d '{"position_seconds": 1800}'
        ```
      operationId: stop_streaming_api_v1_stream__movie_id__stop_post
      parameters:
      - explode: false
        in: path
        name: movie_id
        required: true
        schema:
          title: Movie Id
          type: string
        style: simple
      - explode: false
        in: header
        name: authorization
        required: true
        schema:
          title: Authorization
          type: string
        style: simple
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProgressUpdateRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Stop Streaming
      tags:
      - Streaming
  /:
    get:
      operationId: root__get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
      summary: Root
  /health:
    get:
      description: Health check endpoint
      operationId: health_health_get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
      summary: Health
components:
  schemas:
    HTTPValidationError:
      example:
        detail:
        - msg: msg
          loc:
          - ValidationError_loc_inner
          - ValidationError_loc_inner
          type: type
        - msg: msg
          loc:
          - ValidationError_loc_inner
          - ValidationError_loc_inner
          type: type
      properties:
        detail:
          items:
            $ref: "#/components/schemas/ValidationError"
          title: detail
          type: array
      title: HTTPValidationError
    ProgressUpdateRequest:
      description: Request to update watch progress
      example:
        position_seconds: 0
      properties:
        position_seconds:
          description: Current playback position in seconds
          minimum: 0.0
          title: Position Seconds
          type: integer
      required:
      - position_seconds
      title: ProgressUpdateRequest
    ProgressUpdateResponse:
      description: Response after updating progress
      example:
        position_seconds: 0
        success: true
        message: Progress updated successfully
      properties:
        success:
          title: Success
          type: boolean
        position_seconds:
          title: Position Seconds
          type: integer
        message:
          default: Progress updated successfully
          title: Message
          type: string
      required:
      - position_seconds
      - success
      title: ProgressUpdateResponse
    StreamRequest:
      description: Request to start streaming a movie
      example:
        manifest_type: hls
      properties:
        manifest_type:
          default: hls
          description: "Manifest type: hls or dash"
          title: Manifest Type
          type: string
      title: StreamRequest
    StreamResponse:
      description: Response with streaming manifest URL
      example:
        manifest_type: manifest_type
        manifest_url: manifest_url
        expires_in: 0
      properties:
        manifest_url:
          description: Signed URL for manifest file
          title: Manifest Url
          type: string
        expires_in:
          description: URL expiration in seconds
          title: Expires In
          type: integer
        manifest_type:
          description: Manifest type (hls/dash)
          title: Manifest Type
          type: string
      required:
      - expires_in
      - manifest_type
      - manifest_url
      title: StreamResponse
    ValidationError:
      example:
        msg: msg
        loc:
        - ValidationError_loc_inner
        - ValidationError_loc_inner
        type: type
      properties:
        loc:
          items:
            $ref: "#/components/schemas/ValidationError_loc_inner"
          title: loc
          type: array
        msg:
          title: Message
          type: string
        type:
          title: Error Type
          type: string
      required:
      - loc
      - msg
      - type
      title: ValidationError
    WatchProgressResponse:
      description: Response with watch progress
      example:
        last_watched_at: 2000-01-23T04:56:07.000+00:00
        user_id: user_id
        position_seconds: 0
        movie_id: movie_id
      properties:
        user_id:
          title: User Id
          type: string
        movie_id:
          title: Movie Id
          type: string
        position_seconds:
          title: Position Seconds
          type: integer
        last_watched_at:
          format: date-time
          nullable: true
          title: last_watched_at
          type: string
      required:
      - movie_id
      - position_seconds
      - user_id
      title: WatchProgressResponse
    ValidationError_loc_inner:
      anyOf:
      - type: string
      - type: integer
      title: ValidationError_loc_inner
