openapi: 3.1.0
info:
  description: Payment processing service for online cinema platform with YooMoney
    integration
  title: Payment Service
  version: 1.0.0
servers:
- url: /
paths:
  /api/v1/payments/create-checkout-session:
    post:
      description: |-
        Create checkout session for subscription payment

        **Idempotency:**
        - Use `X-Idempotency-Key` header or `idempotency_key` field
        - Prevents duplicate payments if request is retried
        - Cached for 24 hours

        **Request:**
        ```json
        {
            "plan_id": "premium",
            "user_id": "00000000-0000-0000-0000-000000000001",
            "idempotency_key": "optional-unique-key"
        }
        ```

        **Response:**
        ```json
        {
            "payment_id": "uuid",
            "checkout_url": "https://yookassa.ru/checkout/...",
            "amount": 599.00,
            "currency": "RUB",
            "plan_id": "premium"
        }
        ```

        **Example:**
        ```bash
        curl -X POST http://localhost:8007/api/v1/payments/create-checkout-session \
          -H "Content-Type: application/json" \
          -H "X-Idempotency-Key: unique-key-123" \
          -d '{
            "plan_id": "premium",
            "user_id": "00000000-0000-0000-0000-000000000001"
          }'
        ```
      operationId: create_checkout_session_api_v1_payments_create_checkout_session_post
      parameters:
      - explode: false
        in: header
        name: X-Idempotency-Key
        required: false
        schema:
          nullable: true
          type: string
        style: simple
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCheckoutSessionRequest"
        required: true
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckoutSessionResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Create Checkout Session
      tags:
      - Payments
  /api/v1/payments/webhook:
    post:
      description: |-
        YooMoney webhook handler

        **Supported Events:**
        - `payment.succeeded` - Payment completed successfully
        - `payment.canceled` - Payment cancelled by user or timeout
        - `refund.succeeded` - Refund processed

        **Webhook Configuration:**
        Set webhook URL in YooMoney dashboard:
        ```
        https://your-domain.com/api/v1/payments/webhook
        ```

        **Security:**
        - Webhook signature verification using HMAC-SHA256
        - Set `YOOMONEY_WEBHOOK_SECRET` in environment

        **Example Webhook Payload:**
        ```json
        {
            "type": "notification",
            "event": "payment.succeeded",
            "object": {
                "id": "2d8b8b7a-000f-5000-9000-1b7e3f9e0e9f",
                "status": "succeeded",
                "paid": true,
                "amount": {
                    "value": "599.00",
                    "currency": "RUB"
                },
                "payment_metadata": {
                    "payment_id": "uuid"
                }
            }
        }
        ```

        **Testing:**
        ```bash
        curl -X POST http://localhost:8007/api/v1/payments/webhook \
          -H "Content-Type: application/json" \
          -H "X-YooKassa-Signature: signature" \
          -d '{
            "type": "notification",
            "event": "payment.succeeded",
            "object": {
                "id": "provider-payment-id",
                "status": "succeeded"
            }
          }'
        ```
      operationId: handle_webhook_api_v1_payments_webhook_post
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookResponse"
          description: Successful Response
      summary: Handle Webhook
      tags:
      - Payments
  /api/v1/payments/history:
    get:
      description: |-
        Get payment history for user

        **Query Parameters:**
        - `user_id` - User UUID (required)
        - `page` - Page number (default: 1)
        - `page_size` - Items per page (default: 20, max: 100)

        **Response:**
        ```json
        {
            "payments": [
                {
                    "id": "uuid",
                    "user_id": "uuid",
                    "amount": 599.00,
                    "currency": "RUB",
                    "status": "succeeded",
                    "provider": "yoomoney",
                    "plan_id": "premium",
                    "created_at": "2024-11-16T10:00:00Z"
                }
            ],
            "total": 10,
            "page": 1,
            "page_size": 20
        }
        ```

        **Example:**
        ```bash
        curl "http://localhost:8007/api/v1/payments/history?user_id={uuid}&page=1&page_size=20"
        ```
      operationId: get_payment_history_api_v1_payments_history_get
      parameters:
      - description: User UUID
        explode: true
        in: query
        name: user_id
        required: true
        schema:
          description: User UUID
          format: uuid
          title: User Id
          type: string
        style: form
      - description: Page number
        explode: true
        in: query
        name: page
        required: false
        schema:
          default: 1
          description: Page number
          minimum: 1
          title: Page
          type: integer
        style: form
      - description: Items per page
        explode: true
        in: query
        name: page_size
        required: false
        schema:
          default: 20
          description: Items per page
          maximum: 100
          minimum: 1
          title: Page Size
          type: integer
        style: form
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentHistoryResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Get Payment History
      tags:
      - Payments
  /api/v1/payments/{payment_id}:
    get:
      description: |-
        Get payment details by ID

        **Example:**
        ```bash
        curl "http://localhost:8007/api/v1/payments/{payment_id}"
        ```
      operationId: get_payment_api_v1_payments__payment_id__get
      parameters:
      - explode: false
        in: path
        name: payment_id
        required: true
        schema:
          format: uuid
          title: Payment Id
          type: string
        style: simple
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaymentResponse"
          description: Successful Response
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HTTPValidationError"
          description: Validation Error
      summary: Get Payment
      tags:
      - Payments
  /:
    get:
      description: Root endpoint
      operationId: root__get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
      summary: Root
  /health:
    get:
      description: Health check endpoint
      operationId: health_check_health_get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
      summary: Health Check
  /plans:
    get:
      description: Get available subscription plans
      operationId: get_plans_plans_get
      responses:
        "200":
          content:
            application/json:
              schema: {}
          description: Successful Response
      summary: Get Plans
components:
  schemas:
    CheckoutSessionResponse:
      description: Response with checkout session details
      example:
        amount: 599.0
        checkout_url: https://yoomoney.ru/checkout/...
        currency: RUB
        expires_at: 2024-11-16T12:00:00Z
        payment_id: 00000000-0000-0000-0000-000000000001
        plan_id: premium
      properties:
        payment_id:
          format: uuid4
          title: Payment Id
          type: string
        checkout_url:
          title: Checkout Url
          type: string
        amount:
          title: Amount
          type: number
        currency:
          title: Currency
          type: string
        plan_id:
          title: Plan Id
          type: string
        expires_at:
          format: date-time
          nullable: true
          type: string
      required:
      - amount
      - checkout_url
      - currency
      - payment_id
      - plan_id
      title: CheckoutSessionResponse
    CreateCheckoutSessionRequest:
      description: Request to create checkout session
      example:
        idempotency_key: unique-key-123
        plan_id: premium
        user_id: 00000000-0000-0000-0000-000000000001
      properties:
        plan_id:
          description: "Subscription plan ID (basic, premium, family)"
          title: Plan Id
          type: string
        user_id:
          description: User UUID
          format: uuid4
          title: User Id
          type: string
        idempotency_key:
          nullable: true
          type: string
      required:
      - plan_id
      - user_id
      title: CreateCheckoutSessionRequest
    HTTPValidationError:
      example:
        detail:
        - msg: msg
          loc:
          - ValidationError_loc_inner
          - ValidationError_loc_inner
          type: type
        - msg: msg
          loc:
          - ValidationError_loc_inner
          - ValidationError_loc_inner
          type: type
      properties:
        detail:
          items:
            $ref: "#/components/schemas/ValidationError"
          title: detail
          type: array
      title: HTTPValidationError
    PaymentHistoryResponse:
      description: Payment history response
      example:
        page: 1
        page_size: 20
        payments: []
        total: 10
      properties:
        payments:
          items:
            $ref: "#/components/schemas/PaymentResponse"
          type: array
        total:
          title: Total
          type: integer
        page:
          title: Page
          type: integer
        page_size:
          title: Page Size
          type: integer
      required:
      - page
      - page_size
      - payments
      - total
      title: PaymentHistoryResponse
    PaymentProviderEnum:
      description: Payment provider enum
      enum:
      - yoomoney
      - stripe
      - paypal
      title: PaymentProviderEnum
      type: string
    PaymentResponse:
      description: Payment response
      example:
        amount: 599.0
        checkout_url: https://yoomoney.ru/checkout/...
        completed_at: 2024-11-16T10:05:00Z
        created_at: 2024-11-16T10:00:00Z
        currency: RUB
        id: 00000000-0000-0000-0000-000000000001
        plan_id: premium
        provider: yoomoney
        provider_payment_id: 2d8b8b7a-000f-5000-9000-1b7e3f9e0e9f
        status: succeeded
        subscription_duration_days: 30
        updated_at: 2024-11-16T10:05:00Z
        user_id: 00000000-0000-0000-0000-000000000002
      properties:
        id:
          format: uuid4
          title: Id
          type: string
        user_id:
          format: uuid4
          title: User Id
          type: string
        amount:
          title: Amount
          type: number
        currency:
          title: Currency
          type: string
        status:
          $ref: "#/components/schemas/PaymentStatusEnum"
        provider:
          $ref: "#/components/schemas/PaymentProviderEnum"
        provider_payment_id:
          nullable: true
          type: string
        plan_id:
          nullable: true
          type: string
        subscription_duration_days:
          nullable: true
          type: integer
        checkout_url:
          nullable: true
          type: string
        created_at:
          format: date-time
          title: Created At
          type: string
        updated_at:
          format: date-time
          title: Updated At
          type: string
        completed_at:
          format: date-time
          nullable: true
          type: string
      required:
      - amount
      - created_at
      - currency
      - id
      - provider
      - status
      - updated_at
      - user_id
      title: PaymentResponse
    PaymentStatusEnum:
      description: Payment status enum
      enum:
      - pending
      - processing
      - succeeded
      - failed
      - cancelled
      - refunded
      title: PaymentStatusEnum
      type: string
    ValidationError:
      example:
        msg: msg
        loc:
        - ValidationError_loc_inner
        - ValidationError_loc_inner
        type: type
      properties:
        loc:
          items:
            $ref: "#/components/schemas/ValidationError_loc_inner"
          title: loc
          type: array
        msg:
          title: Message
          type: string
        type:
          title: Error Type
          type: string
      required:
      - loc
      - msg
      - type
      title: ValidationError
    WebhookResponse:
      description: Webhook processing response
      example:
        message: Payment processed successfully
        payment_id: 00000000-0000-0000-0000-000000000001
        success: true
      properties:
        success:
          title: Success
          type: boolean
        message:
          title: Message
          type: string
        payment_id:
          format: uuid4
          nullable: true
          type: string
      required:
      - message
      - success
      title: WebhookResponse
    ValidationError_loc_inner:
      anyOf:
      - type: string
      - type: integer
      title: ValidationError_loc_inner
